name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  ARTIFACT_REPOSITORY: expense-management-app
  BACKEND_SERVICE: expense-backend
  FRONTEND_SERVICE: expense-frontend

jobs:
  backend:
    name: Build & Deploy Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      backend-url: ${{ steps.backend-url.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker auth
        run: |
          REGION_TRIM=$(echo "${{ env.REGION }}" | tr -d '[:space:]')
          gcloud auth configure-docker "${REGION_TRIM}-docker.pkg.dev" --quiet

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        run: |
          REGION_TRIM=$(echo "${{ env.REGION }}" | tr -d '[:space:]')
          PROJECT_TRIM=$(echo "${{ env.PROJECT_ID }}" | tr -d '[:space:]')
          REPO_TRIM=$(echo "${{ env.ARTIFACT_REPOSITORY }}" | tr -d '[:space:]')
          BACKEND_IMAGE="${REGION_TRIM}-docker.pkg.dev/${PROJECT_TRIM}/${REPO_TRIM}/backend:${{ github.sha }}"
          echo "BACKEND_IMAGE=$BACKEND_IMAGE" >> $GITHUB_ENV
          docker build -t "$BACKEND_IMAGE" ./backend
          docker push "$BACKEND_IMAGE"

      - name: Render backend env vars file
        run: |
          cat <<EOF > /tmp/backend.env.yaml
          NODE_ENV: "production"
          PORT: "8080"
          HOST: "0.0.0.0"
          MONGODB_URI: "${{ secrets.BACKEND_MONGODB_URI }}"
          JWT_SECRET: "${{ secrets.BACKEND_JWT_SECRET }}"
          JWT_EXPIRE: "${{ secrets.BACKEND_JWT_EXPIRE }}"
          SUPER_ADMIN_SETUP_KEY: "${{ secrets.BACKEND_SUPER_ADMIN_SETUP_KEY }}"
          EMAIL_HOST: "${{ secrets.BACKEND_EMAIL_HOST }}"
          EMAIL_PORT: "${{ secrets.BACKEND_EMAIL_PORT }}"
          EMAIL_USER: "${{ secrets.BACKEND_EMAIL_USER }}"
          EMAIL_PASSWORD: "${{ secrets.BACKEND_EMAIL_PASSWORD }}"
          EMAIL_FROM: "${{ secrets.BACKEND_EMAIL_FROM }}"
          BACKEND_URL: "${{ secrets.BACKEND_URL }}"
          CURRENCY_API_KEY: "${{ secrets.CURRENCY_API_KEY }}"
          CURRENCY_API_URL: "${{ secrets.CURRENCY_API_URL }}"
          FRONTEND_URL: "${{ secrets.FRONTEND_URL }}"
          RENEWAL_NOTIFICATION_DAYS: "${{ secrets.RENEWAL_NOTIFICATION_DAYS }}"
          AUTO_DELETE_REJECTED_DAYS: "${{ secrets.AUTO_DELETE_REJECTED_DAYS }}"
          AUTO_CANCEL_DAYS_BEFORE: "${{ secrets.AUTO_CANCEL_DAYS_BEFORE }}"
          ENABLE_IN_APP_CRON: "${{ secrets.ENABLE_IN_APP_CRON || 'false' }}"
          CRON_TIMEZONE: "${{ secrets.CRON_TIMEZONE || 'UTC' }}"
          CRON_SECRET: "${{ secrets.CRON_SECRET }}"
          EOF

      - name: Deploy backend to Cloud Run
        env:
          CLOUDSDK_API_ENDPOINT_OVERRIDES_RUN: ""
        run: |
          REGION_TRIM=$(echo "${{ env.REGION }}" | tr -d '[:space:]')
          gcloud run deploy "${{ env.BACKEND_SERVICE }}" \
            --image "$BACKEND_IMAGE" \
            --region "${REGION_TRIM}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --min-instances 1 \
            --env-vars-file /tmp/backend.env.yaml

      - name: Capture backend URL
        id: backend-url
        run: |
          URL=$(gcloud run services describe "${{ env.BACKEND_SERVICE }}" --region "${{ env.REGION }}" --format 'value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

  frontend:
    name: Build & Deploy Frontend
    runs-on: ubuntu-latest
    needs: backend
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker auth
        run: |
          REGION_TRIM=$(echo "${{ env.REGION }}" | tr -d '[:space:]')
          gcloud auth configure-docker "${REGION_TRIM}-docker.pkg.dev" --quiet

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Build and push frontend image
        env:
          BACKEND_URL: ${{ needs.backend.outputs.backend-url }}
          FRONTEND_API_URL: ${{ secrets.FRONTEND_API_URL }}
        run: |
          REGION_TRIM=$(echo "${{ env.REGION }}" | tr -d '[:space:]')
          PROJECT_TRIM=$(echo "${{ env.PROJECT_ID }}" | tr -d '[:space:]')
          REPO_TRIM=$(echo "${{ env.ARTIFACT_REPOSITORY }}" | tr -d '[:space:]')
          API_URL="${BACKEND_URL:-$FRONTEND_API_URL}"
          if [ -z "$API_URL" ]; then
            echo "Backend URL not found. Add FRONTEND_API_URL secret or ensure backend deployed." >&2
            exit 1
          fi
          API_URL="${API_URL%/}"
          FRONTEND_IMAGE="${REGION_TRIM}-docker.pkg.dev/${PROJECT_TRIM}/${REPO_TRIM}/frontend:${{ github.sha }}"
          echo "FRONTEND_IMAGE=$FRONTEND_IMAGE" >> $GITHUB_ENV
          docker build --build-arg VITE_API_URL="${API_URL}/api" -t "$FRONTEND_IMAGE" ./frontend
          docker push "$FRONTEND_IMAGE"

      - name: Deploy frontend to Cloud Run
        env:
          CLOUDSDK_API_ENDPOINT_OVERRIDES_RUN: ""
        run: |
          REGION_TRIM=$(echo "${{ env.REGION }}" | tr -d '[:space:]')
          gcloud run deploy "${{ env.FRONTEND_SERVICE }}" \
            --image "$FRONTEND_IMAGE" \
            --region "${REGION_TRIM}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080

      - name: Frontend URL
        run: gcloud run services describe "${{ env.FRONTEND_SERVICE }}" --region "${{ env.REGION }}" --format 'value(status.url)'
